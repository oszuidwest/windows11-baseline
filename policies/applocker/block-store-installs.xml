<?xml version="1.0" encoding="UTF-8"?>
<!--
    AppLocker Policy: Block Microsoft Store Installations

    Purpose: Prevents users from installing apps via Microsoft Store or StoreInstaller.exe
    Target: Shared systems only

    This policy:
    - Allows all standard executables (Windows, Program Files)
    - Blocks StoreInstaller.exe (the web installer from get.microsoft.com)
    - Allows all signed packaged apps to RUN
    - Blocks Microsoft.WindowsStore from RUNNING (prevents Store app usage)

    Note: The Application Identity service (AppIdSvc) must be running for enforcement.
-->
<AppLockerPolicy Version="1">

    <!-- EXECUTABLE RULES -->
    <RuleCollection Type="Exe" EnforcementMode="Enabled">

        <!-- Default Rule: Allow Windows folder executables for Everyone -->
        <FilePathRule Id="a61c8b2c-a319-4cd0-9690-d2177cad7b51"
                      Name="(Default) Allow Windows folder"
                      Description="Allows everyone to run applications in the Windows folder"
                      UserOrGroupSid="S-1-1-0"
                      Action="Allow">
            <Conditions>
                <FilePathCondition Path="%WINDIR%\*"/>
            </Conditions>
        </FilePathRule>

        <!-- Default Rule: Allow Program Files executables for Everyone -->
        <FilePathRule Id="921cc481-6e17-4653-8f75-050b80acca20"
                      Name="(Default) Allow Program Files"
                      Description="Allows everyone to run applications in Program Files"
                      UserOrGroupSid="S-1-1-0"
                      Action="Allow">
            <Conditions>
                <FilePathCondition Path="%PROGRAMFILES%\*"/>
            </Conditions>
        </FilePathRule>

        <!-- Default Rule: Allow Administrators to run anything -->
        <FilePathRule Id="fd686d83-a829-4351-8ff4-27c7de5755d2"
                      Name="(Default) Allow Administrators"
                      Description="Allows administrators to run all applications"
                      UserOrGroupSid="S-1-5-32-544"
                      Action="Allow">
            <Conditions>
                <FilePathCondition Path="*"/>
            </Conditions>
        </FilePathRule>

        <!-- DENY: Block StoreInstaller.exe (the Microsoft Store web installer) -->
        <FilePublisherRule Id="b7d74306-35f3-4ad6-a29f-796e2491c992"
                           Name="Block StoreInstaller.exe"
                           Description="Blocks the Microsoft Store web installer downloaded from get.microsoft.com"
                           UserOrGroupSid="S-1-1-0"
                           Action="Deny">
            <Conditions>
                <FilePublisherCondition PublisherName="O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US"
                                        ProductName="STOREINSTALLER"
                                        BinaryName="STOREINSTALLER.EXE">
                    <BinaryVersionRange LowSection="*" HighSection="*"/>
                </FilePublisherCondition>
            </Conditions>
        </FilePublisherRule>

    </RuleCollection>

    <!-- PACKAGED APP (APPX/MSIX) RULES -->
    <RuleCollection Type="Appx" EnforcementMode="Enabled">

        <!-- Default Rule: Allow all signed packaged apps for Everyone -->
        <FilePublisherRule Id="a9e18c21-ff8f-43cf-b9fc-db40eed693ba"
                           Name="(Default) Allow all signed packaged apps"
                           Description="Allows everyone to run all signed packaged applications"
                           UserOrGroupSid="S-1-1-0"
                           Action="Allow">
            <Conditions>
                <FilePublisherCondition PublisherName="*" ProductName="*" BinaryName="*">
                    <BinaryVersionRange LowSection="0.0.0.0" HighSection="*"/>
                </FilePublisherCondition>
            </Conditions>
        </FilePublisherRule>

        <!-- DENY: Block Microsoft Store app -->
        <FilePublisherRule Id="a0a3fca2-3820-4489-8db0-4e2fc319b756"
                           Name="Block Microsoft Store"
                           Description="Prevents users from opening the Microsoft Store application"
                           UserOrGroupSid="S-1-1-0"
                           Action="Deny">
            <Conditions>
                <FilePublisherCondition PublisherName="CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US"
                                        ProductName="Microsoft.WindowsStore"
                                        BinaryName="*">
                    <BinaryVersionRange LowSection="*" HighSection="*"/>
                </FilePublisherCondition>
            </Conditions>
        </FilePublisherRule>

        <!-- DENY: Block Microsoft Copilot app -->
        <FilePublisherRule Id="c8d91a3b-5927-4f8a-9c1e-3b6d82f4a509"
                           Name="Block Microsoft Copilot"
                           Description="Prevents users from opening the Microsoft Copilot application"
                           UserOrGroupSid="S-1-1-0"
                           Action="Deny">
            <Conditions>
                <FilePublisherCondition PublisherName="CN=MICROSOFT CORPORATION, O=MICROSOFT CORPORATION, L=REDMOND, S=WASHINGTON, C=US"
                                        ProductName="MICROSOFT.COPILOT"
                                        BinaryName="*">
                    <BinaryVersionRange LowSection="*" HighSection="*"/>
                </FilePublisherCondition>
            </Conditions>
        </FilePublisherRule>

    </RuleCollection>

</AppLockerPolicy>
